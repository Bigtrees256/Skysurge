<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkySurge - Admin Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 40px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .dashboard-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .dashboard-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .dashboard-card .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .status {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status p {
            color: #666;
            margin-bottom: 5px;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .back-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß SkySurge Admin Portal</h1>
            <p>Manage your game, ads, and prize pools</p>
        </div>
        
        <div class="content">
            <a href="index.html" class="back-btn">‚Üê Back to Game</a>
            
            <div class="status">
                <h3>üìä System Status</h3>
                <p><strong>Backend:</strong> <span id="backendStatus">Checking...</span></p>
                <p><strong>Database:</strong> <span id="dbStatus">Checking...</span></p>
                <p><strong>Ad System:</strong> <span id="adStatus">Checking...</span></p>
            </div>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="icon">üõ°Ô∏è</div>
                    <h3>Anti-Cheat Dashboard</h3>
                    <p>Monitor game sessions and detect suspicious activity. View total sessions, flagged activities, and anti-cheat alerts.</p>
                    <a href="admin-dashboard.html" class="btn" target="_blank">Open Dashboard</a>
                </div>
                
                <div class="dashboard-card">
                    <div class="icon">üìà</div>
                    <h3>Ad Analytics</h3>
                    <p>Track ad performance, revenue, and user engagement. Configure ad settings and view detailed analytics.</p>
                    <a href="admin-ads.html" class="btn" target="_blank">Open Dashboard</a>
                </div>
                
                <div class="dashboard-card">
                    <div class="icon">üèÜ</div>
                    <h3>Prize Pool Admin</h3>
                    <p>Manage tournament prizes, distributions, and pool settings. View statistics and manual payout controls.</p>
                    <a href="admin-prize-pool.html" class="btn" target="_blank">Open Dashboard</a>
                </div>
                
                <div class="dashboard-card">
                    <div class="icon">‚è∞</div>
                    <h3>Timer Control</h3>
                    <p>Control contest timing, start/end dates, duration, and pause/resume functionality. Manage the countdown timer.</p>
                    <a href="admin-timer.html" class="btn" target="_blank">Open Dashboard</a>
                </div>
                
                <div class="dashboard-card">
                    <div class="icon">üì∏</div>
                    <h3>Instagram Share Manager</h3>
                    <p>Reset daily Instagram share limits for users. Manage social media sharing quotas and user permissions.</p>
                    <button class="btn" onclick="openInstagramManager()">Open Manager</button>
                </div>

                <div class="dashboard-card">
                    <div class="icon">üéØ</div>
                    <h3>User Attempts Manager</h3>
                    <p>Grant attempts to users, view attempt statistics, and manage user attempt limits. Monitor system-wide attempt usage.</p>
                    <button class="btn" onclick="openAttemptsManager()">Open Manager</button>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px; color: #666;">
                <p><strong>Quick Access URLs:</strong></p>
                <p style="font-family: monospace; font-size: 0.9em;">
                    http://localhost:8000/admin-dashboard.html<br>
                    http://localhost:8000/admin-ads.html<br>
                    http://localhost:8000/admin-prize-pool.html<br>
                    http://localhost:8000/admin-timer.html
                </p>
            </div>
            
            <!-- Instagram Share Manager Modal -->
            <div id="instagramModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; position: relative;">
                    <button onclick="closeInstagramManager()" style="position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">‚úï</button>
                    
                    <h2 style="color: #E1306C; margin-bottom: 20px; text-align: center;">üì∏ Instagram Share Manager</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="resetUsername" style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Username:</label>
                        <input id="resetUsername" type="text" placeholder="Enter username to reset" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                        <button onclick="resetInstagramShare()" id="resetBtn" style="background: #E1306C; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">Reset Instagram Share Limit</button>
                    </div>
                    
                    <div id="resetResult" style="text-align: center; font-weight: bold; padding: 10px; border-radius: 8px; margin-top: 15px;"></div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="color: #333; margin-bottom: 10px;">‚ÑπÔ∏è How it works:</h4>
                        <ul style="color: #666; text-align: left; line-height: 1.5;">
                            <li>Enter a username to reset their daily Instagram share limit</li>
                            <li>This will allow them to share on Instagram again for bonus attempts</li>
                            <li>The reset is immediate and affects only the specified user</li>
                            <li>Users normally get 3 Instagram shares per day</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- User Attempts Manager Modal -->
            <div id="attemptsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                    <button onclick="closeAttemptsManager()" style="position: absolute; top: 15px; right: 15px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">‚úï</button>

                    <h2 style="color: #667eea; margin-bottom: 20px; text-align: center;">üéØ User Attempts Manager</h2>

                    <!-- Statistics Section -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e9ecef;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Players</div>
                            <div id="totalPlayersCount" style="font-size: 20px; font-weight: bold; color: #667eea;">Loading...</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e9ecef;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Active Players</div>
                            <div id="activePlayersCount" style="font-size: 20px; font-weight: bold; color: #28a745;">Loading...</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e9ecef;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Attempts Used</div>
                            <div id="totalAttemptsUsedCount" style="font-size: 20px; font-weight: bold; color: #dc3545;">Loading...</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #e9ecef;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Attempts Granted</div>
                            <div id="totalAttemptsGrantedCount" style="font-size: 20px; font-weight: bold; color: #17a2b8;">Loading...</div>
                        </div>
                    </div>

                    <!-- User Search Section -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #333;">üîç Find User</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                            <input type="text" id="attemptsSearchUsername" placeholder="Enter username..."
                                   style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <button onclick="searchUserAttempts()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üîç Search</button>
                            <button onclick="loadAllUsersAttempts()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">üìã View All</button>
                        </div>
                        <div id="attemptsUserSearchResult"></div>
                    </div>

                    <!-- Grant Attempts Section -->
                    <div style="background: #e8f5e8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #28a745;">
                        <h3 style="margin: 0 0 15px 0; color: #28a745;">üéÅ Grant Attempts to User</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Username:</label>
                                <input type="text" id="attemptsGrantUsername" placeholder="Enter username..."
                                       style="width: 100%; padding: 10px; border: 2px solid #28a745; border-radius: 5px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Amount:</label>
                                <input type="number" id="attemptsGrantAmount" value="1" min="1" max="100"
                                       style="width: 100%; padding: 10px; border: 2px solid #28a745; border-radius: 5px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Type:</label>
                                <select id="attemptsGrantType" style="width: 100%; padding: 10px; border: 2px solid #28a745; border-radius: 5px; font-size: 14px;">
                                    <option value="bonus">Bonus</option>
                                    <option value="purchase">Purchase</option>
                                    <option value="referral">Referral</option>
                                    <option value="ad">Ad Reward</option>
                                </select>
                            </div>
                            <button onclick="grantUserAttempts()" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">üéÅ Grant</button>
                        </div>
                        <div id="attemptsGrantResult" style="margin-top: 15px;"></div>
                    </div>

                    <!-- Reset Tools Section -->
                    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border: 2px solid #ffc107;">
                        <h3 style="margin: 0 0 15px 0; color: #856404;">üîÑ Reset User Limits</h3>
                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Username:</label>
                                <input type="text" id="attemptsResetUsername" placeholder="Enter username..."
                                       style="width: 100%; padding: 10px; border: 2px solid #ffc107; border-radius: 5px; font-size: 14px;">
                            </div>
                            <button onclick="resetUserInstagramLimit()" style="background: #E1306C; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">üì∏ Reset Instagram</button>
                            <button onclick="resetUserDailyAttempts()" style="background: #ffc107; color: #000; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">üîÑ Reset Daily</button>
                        </div>
                        <div id="attemptsResetResult" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration -->
    <script src="js/config.js"></script>

    <script>
        const API_BASE = window.AppConfig ? window.AppConfig.apiBaseUrl : 'http://localhost:3000';

        // Load AuthManager
        const authScript = document.createElement('script');
        authScript.src = 'js/AuthManager.js';
        authScript.onload = function() {
            checkAdminAuth();
        };
        document.head.appendChild(authScript);
        
        // Check admin authentication
        async function checkAdminAuth() {
            // Wait for auth manager to initialize
            if (!authManager || !authManager.isInitialized) {
                setTimeout(checkAdminAuth, 100);
                return;
            }
            
            if (!authManager.isAuthenticated()) {
                alert('‚ùå Admin access required. Please log in first.');
                window.location.href = 'login.html';
                return false;
            }
            
            if (!authManager.isAdmin()) {
                alert('‚ùå Admin access required. You do not have admin privileges.');
                window.location.href = 'index.html';
                return false;
            }
            
            console.log('‚úÖ Admin access verified');
            return true;
        }
        
        // Check system status
        async function checkStatus() {
            try {
                // Check backend
                const backendResponse = await fetch(`${API_BASE}/health`);
                if (backendResponse.ok) {
                    document.getElementById('backendStatus').textContent = '‚úÖ Online';
                    document.getElementById('backendStatus').style.color = '#28a745';
                } else {
                    document.getElementById('backendStatus').textContent = '‚ùå Offline';
                    document.getElementById('backendStatus').style.color = '#dc3545';
                }
            } catch (error) {
                document.getElementById('backendStatus').textContent = '‚ùå Offline';
                document.getElementById('backendStatus').style.color = '#dc3545';
            }
            
            try {
                // Check database
                const dbResponse = await fetch(`${API_BASE}/api/attempts/my`);
                if (dbResponse.status === 401) {
                    document.getElementById('dbStatus').textContent = '‚úÖ Connected';
                    document.getElementById('dbStatus').style.color = '#28a745';
                } else {
                    document.getElementById('dbStatus').textContent = '‚ö†Ô∏è Limited';
                    document.getElementById('dbStatus').style.color = '#ffc107';
                }
            } catch (error) {
                document.getElementById('dbStatus').textContent = '‚ùå Error';
                document.getElementById('dbStatus').style.color = '#dc3545';
            }
            
            // Ad system status
            document.getElementById('adStatus').textContent = '‚úÖ Ready';
            document.getElementById('adStatus').style.color = '#28a745';
        }
        
        // Check status on load
        checkStatus();
        
        // Refresh status every 30 seconds
        setInterval(checkStatus, 30000);
        
        // Check admin auth on page load
        document.addEventListener('DOMContentLoaded', async function() {
            if (!(await checkAdminAuth())) {
                return;
            }
        });
        
        // Instagram Share Manager Functions
        function openInstagramManager() {
            document.getElementById('instagramModal').style.display = 'flex';
            document.getElementById('resetUsername').value = '';
            document.getElementById('resetResult').textContent = '';
            document.getElementById('resetResult').style.background = '';
        }
        
        function closeInstagramManager() {
            document.getElementById('instagramModal').style.display = 'none';
        }
        
        async function resetInstagramShare() {
            const username = document.getElementById('resetUsername').value.trim();
            const resultDiv = document.getElementById('resetResult');
            const resetBtn = document.getElementById('resetBtn');
            
            if (!username) {
                resultDiv.textContent = 'Please enter a username.';
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                return;
            }
            
            resetBtn.disabled = true;
            resetBtn.textContent = 'Resetting...';
            resultDiv.textContent = '';
            
            try {
                const response = await fetch(`${API_BASE}/api/attempts/admin/reset-instagram/${encodeURIComponent(username)}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.textContent = `‚úÖ ${data.message}`;
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                } else {
                    resultDiv.textContent = `‚ùå ${data.error || 'Reset failed'}`;
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                }
            } catch (error) {
                resultDiv.textContent = '‚ùå Network error. Please try again.';
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
            }
            
            resetBtn.disabled = false;
            resetBtn.textContent = 'Reset Instagram Share Limit';
        }
        
        // Close modal when clicking outside
        document.getElementById('instagramModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeInstagramManager();
            }
        });

        // User Attempts Manager Functions
        function openAttemptsManager() {
            document.getElementById('attemptsModal').style.display = 'flex';
            loadAttemptsStatistics();
            clearAttemptsForm();
        }

        function closeAttemptsManager() {
            document.getElementById('attemptsModal').style.display = 'none';
        }

        function clearAttemptsForm() {
            document.getElementById('attemptsSearchUsername').value = '';
            document.getElementById('attemptsGrantUsername').value = '';
            document.getElementById('attemptsGrantAmount').value = '1';
            document.getElementById('attemptsResetUsername').value = '';
            document.getElementById('attemptsUserSearchResult').innerHTML = '';
            document.getElementById('attemptsGrantResult').innerHTML = '';
            document.getElementById('attemptsResetResult').innerHTML = '';
        }

        // Load attempts statistics
        async function loadAttemptsStatistics() {
            try {
                const response = await fetch(`${API_BASE}/api/attempts/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalPlayersCount').textContent = data.totalPlayers || 0;
                    document.getElementById('activePlayersCount').textContent = data.activePlayers || 0;
                    document.getElementById('totalAttemptsUsedCount').textContent = data.totalAttemptsUsed || 0;
                    document.getElementById('totalAttemptsGrantedCount').textContent = data.totalAttemptsGranted || 0;
                } else {
                    throw new Error('Failed to load statistics');
                }
            } catch (error) {
                console.error('Failed to load attempts statistics:', error);
                document.getElementById('totalPlayersCount').textContent = 'Error';
                document.getElementById('activePlayersCount').textContent = 'Error';
                document.getElementById('totalAttemptsUsedCount').textContent = 'Error';
                document.getElementById('totalAttemptsGrantedCount').textContent = 'Error';
            }
        }

        // Search for a specific user
        async function searchUserAttempts() {
            const username = document.getElementById('attemptsSearchUsername').value.trim();
            const resultDiv = document.getElementById('attemptsUserSearchResult');

            if (!username) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Please enter a username to search</div>';
                return;
            }

            // Show loading state
            resultDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px;">üîç Searching for user...</div>';

            try {
                const response = await fetch(`http://localhost:3000/api/attempts/user/${encodeURIComponent(username)}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0;">üë§ User: ${data.username}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div><strong>Total:</strong> ${data.totalAttempts || 0}</div>
                                <div><strong>Used:</strong> ${data.attemptsUsed || 0}</div>
                                <div><strong>Remaining:</strong> ${data.remainingAttempts || 0}</div>
                                <div><strong>Purchase:</strong> ${data.purchaseAttempts || 0}</div>
                                <div><strong>Referral:</strong> ${data.referralAttempts || 0}</div>
                                <div><strong>Ads:</strong> ${data.adsWatched || 0}</div>
                                <div><strong>Bonus:</strong> ${data.bonusAttempts || 0}</div>
                                <div><strong>Last Used:</strong> ${data.lastAttemptUsed ? new Date(data.lastAttemptUsed).toLocaleDateString() : 'Never'}</div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="fillAttemptsGrantForm('${data.username}')" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Grant Attempts</button>
                                <button onclick="resetInstagramLimit('${data.username}')" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">Reset Instagram Limit</button>
                            </div>
                        </div>
                    `;
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">‚ùå ${errorData.error || 'User not found'}</div>`;
                }
            } catch (error) {
                console.error('Search user error:', error);
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">‚ùå Error searching for user. Please check your connection.</div>';
            }
        }

        // Load all users (paginated)
        async function loadAllUsersAttempts() {
            const resultDiv = document.getElementById('attemptsUserSearchResult');
            resultDiv.innerHTML = '<div style="text-align: center; padding: 20px;">üîÑ Loading all users...</div>';

            try {
                const response = await fetch('http://localhost:3000/api/attempts/admin/all?limit=10', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.players && data.players.length > 0) {
                        let tableHtml = `
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Username</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Total</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Used</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Remaining</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Last Used</th>
                                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        data.players.forEach(player => {
                            tableHtml += `
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${player.username}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${player.totalAttempts}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${player.attemptsUsed}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${player.remainingAttempts}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">${player.lastAttemptUsed ? new Date(player.lastAttemptUsed).toLocaleDateString() : 'Never'}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ddd;">
                                        <button onclick="fillAttemptsGrantForm('${player.username}')" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">Grant</button>
                                    </td>
                                </tr>
                            `;
                        });

                        tableHtml += '</tbody></table>';
                        resultDiv.innerHTML = tableHtml;
                    } else {
                        resultDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 5px;">No users found</div>';
                    }
                } else {
                    resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Failed to load users</div>';
                }
            } catch (error) {
                console.error('Load all users error:', error);
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Error loading users</div>';
            }
        }

        // Fill grant form with username
        function fillAttemptsGrantForm(username) {
            document.getElementById('attemptsGrantUsername').value = username;
        }

        // Reset Instagram share limit for a user
        async function resetInstagramLimit(username) {
            if (!confirm(`Are you sure you want to reset the Instagram share limit for ${username}?`)) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/attempts/admin/reset-instagram/${encodeURIComponent(username)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(`‚úÖ ${data.message}`);
                    // Refresh the user search to show updated data
                    searchUserAttempts();
                } else {
                    const errorData = await response.json();
                    alert(`‚ùå Error: ${errorData.error}`);
                }
            } catch (error) {
                console.error('Reset Instagram limit error:', error);
                alert('‚ùå Error resetting Instagram limit. Please try again.');
            }
        }

        // Grant attempts to user
        async function grantUserAttempts() {
            const username = document.getElementById('attemptsGrantUsername').value.trim();
            const amount = parseInt(document.getElementById('attemptsGrantAmount').value);
            const type = document.getElementById('attemptsGrantType').value;
            const resultDiv = document.getElementById('attemptsGrantResult');

            if (!username) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Please enter a username</div>';
                return;
            }

            if (!amount || amount < 1 || amount > 100) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Please enter a valid amount (1-100)</div>';
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/attempts/admin/grant/${encodeURIComponent(username)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: type,
                        amount: amount,
                        metadata: {
                            grantedBy: 'admin',
                            reason: 'Admin grant',
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">
                            ‚úÖ Successfully granted ${amount} ${type} attempts to ${username}!<br>
                            New total: ${data.attempts.totalAttempts} attempts
                        </div>
                    `;

                    // Clear form
                    document.getElementById('attemptsGrantUsername').value = '';
                    document.getElementById('attemptsGrantAmount').value = '1';

                    // Refresh stats
                    loadAttemptsStatistics();
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Failed to grant attempts: ${errorData.error}</div>`;
                }
            } catch (error) {
                console.error('Grant attempts error:', error);
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Error granting attempts</div>';
            }
        }

        // Reset Instagram limit for user
        async function resetUserInstagramLimit() {
            const username = document.getElementById('attemptsResetUsername').value.trim();
            const resultDiv = document.getElementById('attemptsResetResult');

            if (!username) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Please enter a username</div>';
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/api/attempts/admin/reset-instagram/${encodeURIComponent(username)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">‚úÖ ${data.message}</div>`;
                    document.getElementById('attemptsResetUsername').value = '';
                } else {
                    const errorData = await response.json();
                    resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Failed to reset: ${errorData.error}</div>`;
                }
            } catch (error) {
                console.error('Reset Instagram error:', error);
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Error resetting Instagram limit</div>';
            }
        }

        // Reset daily attempts for user (placeholder)
        async function resetUserDailyAttempts() {
            const username = document.getElementById('attemptsResetUsername').value.trim();
            const resultDiv = document.getElementById('attemptsResetResult');

            if (!username) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Please enter a username</div>';
                return;
            }

            // This would require a new backend endpoint
            resultDiv.innerHTML = '<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">Daily attempts reset not yet implemented in backend</div>';
        }

        // Close modal when clicking outside
        document.getElementById('attemptsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAttemptsManager();
            }
        });

        // Add Enter key support for search
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('attemptsSearchUsername');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchUserAttempts();
                    }
                });
            }
        });
    </script>
</body>
</html> 