<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶Ö</text></svg>">
    <title>SkySurge - Flying Game</title>
    <!-- Google Fonts: Press Start 2P for retro pixel look -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Firebase App (the core Firebase SDK) - Updated to latest version -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Configuration -->
    <script src="js/config.js?v=simple-fix"></script>

    <!-- Global Error Handler for Extension Errors -->
    <script>
        // Handle unhandled promise rejections (often from browser extensions)
        window.addEventListener('unhandledrejection', function(event) {
            // Check if it's a browser extension error
            if (event.reason &&
                (event.reason.message?.includes('message channel closed') ||
                 event.reason.message?.includes('Extension context invalidated') ||
                 event.reason.message?.includes('The message port closed') ||
                 event.reason.message?.includes('listener indicated an asynchronous response'))) {

                console.log('üîá Suppressed browser extension error:', event.reason.message);
                event.preventDefault(); // Prevent the error from being logged
                return;
            }

            // Log other unhandled rejections (these might be real issues)
            console.error('‚ùå Unhandled promise rejection:', event.reason);
        });

        // Handle general errors
        window.addEventListener('error', function(event) {
            // Check if it's a browser extension error
            if (event.message?.includes('message channel closed') ||
                event.message?.includes('Extension context invalidated') ||
                event.message?.includes('listener indicated an asynchronous response')) {

                console.log('üîá Suppressed browser extension error:', event.message);
                event.preventDefault();
                return;
            }

            // Log other errors (these are likely real application issues)
            console.error('‚ùå JavaScript error:', event.error || event.message);
        });
    </script>

    <!-- Firebase Configuration -->
    <script>
        // Initialize Firebase with centralized config
        firebase.initializeApp(window.AppConfig.firebaseConfig);
    </script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', monospace;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #gameContainer {
            position: relative;
            background: #fff;
            border: none;
            border-bottom: 2px solid #222;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            overflow: hidden;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #gameCanvas {
            display: block;
            background: #fff;
            border: none;
            border-radius: 0;
            box-shadow: none;
            margin: 0;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .ui-element {
            pointer-events: auto;
        }
        /* Ensure attempts counter styling is consistent for start and game over screens */
        #startAttemptsCounter, #gameOverAttemptsCounter {
            background: #f8f8f8 !important;
            color: #222 !important;
            padding: 12px 18px !important;
            border: 2px solid #222 !important;
            border-radius: 0 !important;
            font-family: 'Press Start 2P', monospace !important;
            font-weight: bold !important;
            font-size: 14px !important;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2) !important;
            text-transform: uppercase !important;
        }
        /* Leaderboard styles */
        #leaderboardSection {
            background: #fff;
            border: 2px solid #222;
            border-radius: 0;
            padding: 20px;
            min-width: 400px;
            max-width: 600px;
            text-align: center;
        }
        #leaderboardSection h2 {
            color: #222;
            font-size: 1.2rem;
            margin: 0 0 15px 0;
            text-transform: uppercase;
        }
        #leaderboardList {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.8rem;
        }
        #leaderboardList li {
            padding: 8px 12px;
            margin: 4px 0;
            background: #f8f8f8;
            border: 1px solid #ddd;
            display: grid;
            grid-template-columns: 40px 1fr 120px;
            gap: 10px;
            align-items: center;
        }
        #leaderboardList li:nth-child(1) {
            background: #222;
            color: #fff;
            font-weight: bold;
        }
        #leaderboardList li:nth-child(2) {
            background: #444;
            color: #fff;
        }
        #leaderboardList li:nth-child(3) {
            background: #666;
            color: #fff;
        }
        /* Fix username color for top 3 places */
        #leaderboardList li:nth-child(1) .score-username,
        #leaderboardList li:nth-child(2) .score-username,
        #leaderboardList li:nth-child(3) .score-username {
            color: #ccc !important;
        }
        .score-rank {
            font-weight: bold;
            text-align: center;
            min-width: 40px;
        }
        .score-value {
            font-weight: bold;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .score-username {
            font-size: 0.7rem;
            color: #666;
            font-weight: normal;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* Flat, minimal button style */
        button, .modern-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: 0.9rem;
            border: 2px solid #222;
            border-radius: 0;
            padding: 10px 18px;
            background: #fff;
            color: #222;
            box-shadow: none;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
            margin: 8px 0;
        }
        button:hover, .modern-btn:hover {
            background: #222;
            color: #fff;
        }
        button:active, .modern-btn:active {
            background: #eaeaea;
            color: #222;
        }
        /* Flat overlays/modals */
        .glass {
            background: #fff;
            box-shadow: none;
            border-radius: 0;
            border: 2px solid #222;
        }
        /* Responsive */
        @media (max-width: 900px) {
            body {
                padding: 0;
            }
            #gameCanvas {
                width: 98vw !important;
                height: 70vw !important;
                max-width: 98vw;
                max-height: 70vw;
            }
            #gameContainer {
                max-width: 99vw;
                margin: 0 auto;
                justify-content: center;
            }
            #leaderboardSection {
                min-width: 90vw;
                max-width: 90vw;
            }
            #contest-header {
                padding: 8px 15px;
            }
            #countdown-timer {
                font-size: 0.7rem;
            }
            #countdown-timer div:first-child {
                font-size: 0.6rem;
            }
            #rules-tab {
                font-size: 0.7rem;
                padding: 6px 12px;
            }
        }
        @media (max-width: 600px) {
            #gameCanvas {
                width: 98vw !important;
                height: 60vw !important;
            }
            #leaderboardSection {
                padding: 15px;
            }
            #leaderboardSection h2 {
                font-size: 1rem;
            }
            #leaderboardList {
                font-size: 0.7rem;
            }
            #leaderboardList li {
                grid-template-columns: 30px 1fr 80px;
                gap: 8px;
                padding: 6px 8px;
            }
            .score-rank {
                min-width: 30px;
                font-size: 0.8rem;
            }
            .score-value {
                font-size: 0.8rem;
            }
            .score-username {
                font-size: 0.6rem;
            }
            #contest-header {
                padding: 6px 10px;
                flex-direction: column;
                gap: 5px;
            }
            #user-info {
                min-width: auto !important;
                text-align: center !important;
                font-size: 0.6rem !important;
            }
            #countdown-timer {
                font-size: 0.6rem;
            }
            #countdown-timer div:first-child {
                font-size: 0.5rem;
            }
            #rules-tab {
                font-size: 0.6rem;
                padding: 4px 8px;
            }
            #contest-header > div:last-child {
                min-width: auto !important;
                text-align: center !important;
            }
            #gameContainer {
                margin-top: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- Countdown Timer and Rules Tab -->
    <div id="contest-header" style="position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); border-bottom: 2px solid #222; z-index: 999; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px);">
        <!-- User Info Section -->
        <div id="user-info" style="font-family: 'Press Start 2P', monospace; font-size: 0.7rem; color: #222; text-align: left; min-width: 200px;">
            <div style="margin-bottom: 3px; color: #667eea;">üë§ PLAYER</div>
            <div id="username-display" style="font-weight: bold; color: #222;">Loading...</div>
        </div>

        <!-- Contest Timer -->
        <div id="countdown-timer" style="font-family: 'Press Start 2P', monospace; font-size: 0.9rem; color: #222; text-align: center; flex: 1;">
            <div style="font-size: 0.7rem; margin-bottom: 5px;">üèÜ CONTEST ENDS IN</div>
            <div id="timer-display" style="font-weight: bold; color: #667eea;">Loading...</div>
        </div>

        <!-- Rules Button and Login Button -->
        <div style="min-width: 200px; text-align: right;">
            <button id="rules-tab" class="modern-btn" style="margin: 0; font-size: 0.8rem; padding: 8px 16px; margin-right: 10px;" onclick="window.open('rules.html', '_blank')">üìã RULES</button>
            <button id="login-btn" class="modern-btn" style="margin: 0; font-size: 0.8rem; padding: 8px 16px; background: #28a745; color: white; display: none;" onclick="showLoginModal()">üîê LOGIN</button>
        </div>
    </div>

    <div id="loadingMessage" style="display:block; text-align:center; color:#667eea; font-size:1rem; margin-top:20px;">Checking authentication...</div>

    <!-- Login Modal -->
    <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; flex-direction: column;">
        <div style="background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); text-align: center; max-width: 400px; width: 90%; position: relative;">
            <button onclick="hideLoginModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">√ó</button>

            <h2 style="color: #667eea; margin-bottom: 30px; font-size: 1.2rem; font-family: 'Press Start 2P', monospace;">LOGIN</h2>

            <!-- Google Login Button -->
            <button id="googleLoginBtn" class="modern-btn" style="width: 100%; padding: 15px; margin-bottom: 10px; background: #4285f4; color: white; border: none; border-radius: 8px; font-size: 0.8rem; cursor: pointer;">
                üîê Sign in with Google
            </button>

            <!-- Alternative Google Login (Redirect) -->
            <button id="googleRedirectBtn" class="modern-btn" style="width: 100%; padding: 10px; margin-bottom: 10px; background: #357ae8; color: white; border: none; border-radius: 8px; font-size: 0.7rem; cursor: pointer; display: none;">
                üîÑ Try Google Login (Redirect)
            </button>

            <!-- Popup Test Button -->
            <button id="testPopupBtn" class="modern-btn" style="width: 100%; padding: 8px; margin-bottom: 20px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 0.6rem; cursor: pointer; display: none;">
                üß™ Test if Popups Work
            </button>

            <div style="margin: 20px 0; color: #666; font-size: 0.7rem;">OR</div>

            <!-- Email/Password Form -->
            <form id="emailLoginForm" style="text-align: left;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 0.6rem; color: #555;">EMAIL</label>
                    <input type="email" id="modalEmail" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.8rem; font-family: Arial, sans-serif;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 0.6rem; color: #555;">PASSWORD</label>
                    <input type="password" id="modalPassword" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.8rem; font-family: Arial, sans-serif;">
                </div>
                <button type="submit" class="modern-btn" style="width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 0.8rem; cursor: pointer;">
                    LOGIN
                </button>
            </form>

            <div id="loginMessage" style="margin-top: 15px; font-size: 0.7rem; display: none;"></div>

            <div style="margin-top: 20px; font-size: 0.6rem; color: #666;">
                Don't have an account? <a href="register.html" style="color: #667eea; text-decoration: none;">Sign up here</a>
            </div>
        </div>
    </div>



    <div id="gameContainer" class="glass" style="margin-top: 80px;">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="ui-overlay" id="uiOverlay"></div>
    </div>
    
    <!-- Prize Pool Widget Container -->
    <div id="prize-pool-container" style="position: fixed; top: 80px; left: 20px; width: 350px; z-index: 1000;"></div>

    <!-- Daily Free Attempt Button -->
    <div id="daily-free-attempt" style="position: fixed; top: 200px; left: 20px; width: 350px; z-index: 1000; display: none;">
        <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); margin: 10px 0; text-align: center; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: space-between;">
            <div style="position: relative; z-index: 2; display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 16px; font-weight: 600;">üéÅ Daily Free Attempt</span>
                <button id="claimDailyBtn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease;" onclick="claimDailyFreeAttempt()">
                    Claim
                </button>
            </div>
            <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 60px; height: 60px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
        </div>
    </div>

    <!-- Stripe Checkout Buttons -->
    <div id="stripe-purchase-options" style="margin: 30px 0; text-align: center;">
        <button onclick="purchaseAttemptsStripe('3')" class="modern-btn">Buy 3 Attempts for $0.99</button>
        <button onclick="purchaseAttemptsStripe('10')" class="modern-btn">Buy 10 Attempts for $2</button>
        <button onclick="purchaseAttemptsStripe('30')" class="modern-btn">Buy 30 Attempts for $5</button>
    </div>
    
    <div id="leaderboardSection">
        <h2>üèÜ Top 10 Leaderboard</h2>
        <ul id="leaderboardList">
            <li><span class="score-rank">1.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">2.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">3.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">4.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">5.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">6.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">7.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">8.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">9.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
            <li><span class="score-rank">10.</span><span class="score-value">Loading...</span><span class="score-username">-</span></li>
        </ul>
        <button id="logoutBtn" class="modern-btn" style="margin-top: 15px;">Logout</button>
        <button id="adminBtn" class="modern-btn" style="margin-top: 10px; background: #667eea; color: white; display: none;" onclick="window.open('admin.html', '_blank')">üîß Admin Panel</button>
    </div>
    
    <!-- Countdown Timer Script -->
    <script>
        // Countdown Timer Functionality
        function updateCountdown() {
            // Start with fallback timer immediately (7 days from now)
            let contestEndDate = new Date();
            contestEndDate.setDate(contestEndDate.getDate() + 7);
            
            // Try to sync with backend if available (non-blocking)
            const apiUrl = window.AppConfig ? `${window.AppConfig.apiBaseUrl}/api/prize-pool/current` : 'http://localhost:3000/api/prize-pool/current';
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.pool.nextDistribution) {
                        contestEndDate = new Date(data.pool.nextDistribution);
                        console.log('‚úÖ Contest end time synced from backend:', contestEndDate);
                    }
                })
                .catch(error => {
                    console.log('‚ö†Ô∏è Using fallback timer (backend unavailable)');
                });
            
            function updateTimer() {
                const now = new Date().getTime();
                const distance = contestEndDate.getTime() - now;
                
                if (distance < 0) {
                    document.getElementById('timer-display').innerHTML = 'CONTEST ENDED';
                    document.getElementById('timer-display').style.color = '#ff4444';
                    return;
                }
                
                // Calculate time units
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                // Format display
                let displayText = '';
                if (days > 0) {
                    displayText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                } else if (hours > 0) {
                    displayText = `${hours}h ${minutes}m ${seconds}s`;
                } else if (minutes > 0) {
                    displayText = `${minutes}m ${seconds}s`;
                } else {
                    displayText = `${seconds}s`;
                }
                
                document.getElementById('timer-display').innerHTML = displayText;
                
                // Change color when less than 24 hours remaining
                if (days === 0 && hours < 24) {
                    document.getElementById('timer-display').style.color = '#ff6b6b';
                } else if (days === 0 && hours < 1) {
                    document.getElementById('timer-display').style.color = '#ff4444';
                }
            }
            
            // Start timer immediately and update every second
            updateTimer();
            setInterval(updateTimer, 1000);
        }
        
        // Initialize countdown when page loads
        document.addEventListener('DOMContentLoaded', updateCountdown);
    </script>

    <!-- Username Display Script -->
    <script>
        // Function to display username in header
        function displayUsername(username) {
            const usernameDisplay = document.getElementById('username-display');
            if (usernameDisplay && username) {
                usernameDisplay.textContent = username;
                usernameDisplay.style.color = '#222';
                console.log('‚úÖ Username displayed in header:', username);
            } else {
                console.warn('‚ö†Ô∏è Could not display username:', { usernameDisplay, username });
            }
        }

        // Function to show loading state for username
        function showUsernameLoading() {
            const usernameDisplay = document.getElementById('username-display');
            if (usernameDisplay) {
                usernameDisplay.textContent = 'Loading...';
                usernameDisplay.style.color = '#666';
            }
        }

        // Function to show username error
        function showUsernameError() {
            const usernameDisplay = document.getElementById('username-display');
            if (usernameDisplay) {
                usernameDisplay.textContent = 'Error';
                usernameDisplay.style.color = '#dc3545';
            }
        }

        // Initialize username display
        document.addEventListener('DOMContentLoaded', showUsernameLoading);
    </script>

    <!-- Authentication Check - Must run first -->
    <script>
        // Always attach logout button handler
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await firebase.auth().signOut();
                        window.location.href = 'login.html';
                    } catch (error) {
                        alert('Logout failed: ' + error.message);
                    }
                });
            }
        });
        
        // Show loading message
        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
        }
        
        // Initialize attempts system after all scripts are loaded
        async function initializeAttemptsSystem() {
            if (window.game && window.game.initAttemptsSystem) {
                const success = window.game.initAttemptsSystem();
                if (success) {
                    console.log('‚úÖ Attempts system initialized successfully');
                } else {
                    console.log('‚ùå Failed to initialize attempts system');
                }
            } else {
                // Retry after a short delay
                setTimeout(initializeAttemptsSystem, 100);
            }
        }
        
        // Simple authentication check
        (function() {
            console.log('üîç Main page - Starting simple auth check...');

            // Show loading state
            document.getElementById('gameContainer').style.display = 'none';

            // Set timeout to prevent infinite loading (increased for slower connections)
            const authTimeout = setTimeout(() => {
                console.log('‚ö†Ô∏è Auth timeout - showing login prompt');
                showUnauthenticatedState();
            }, 15000);

            // Check auth state
            firebase.auth().onAuthStateChanged(async (user) => {
                console.log('üîç Auth state changed:', user ? user.email : 'No user');
                clearTimeout(authTimeout); // Clear timeout since auth state changed
                showLoading(false);

                if (!user) {
                    console.log('‚ùå No user authenticated - showing login prompt');
                    showUnauthenticatedState();
                    return;
                }

                console.log('‚úÖ User authenticated:', user.email);
                console.log('‚úÖ User details:', {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    emailVerified: user.emailVerified
                });

                // Store token
                try {
                    const token = await user.getIdToken();
                    localStorage.setItem('authToken', token);
                } catch (error) {
                    console.error('Token error:', error);
                }

                // Check if user needs username setup
                try {
                    const response = await fetch(`${window.AppConfig.apiBaseUrl}/api/auth/user-info`, {
                        headers: { 'Authorization': `Bearer ${await user.getIdToken()}` }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        if (!userData.user.hasUsername) {
                            console.log('‚ö†Ô∏è User needs username setup');
                            window.location.href = 'setup-username.html';
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('Backend check failed:', error);
                    // Continue anyway for now
                }

                // Show authenticated state
                showAuthenticatedState();

                // Initialize game systems
                if (document.readyState === 'complete') {
                    await initializeAttemptsSystem();
                } else {
                    document.addEventListener('DOMContentLoaded', initializeAttemptsSystem);
                }
            });
        })();

        // Show unauthenticated state
        function showUnauthenticatedState() {
            console.log('üîç Showing unauthenticated state');
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('login-btn').style.display = 'inline-block';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Show authenticated state
        function showAuthenticatedState() {
            console.log('‚úÖ Showing authenticated state');
            document.getElementById('gameContainer').style.display = 'block';
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('user-info').style.display = 'block';
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // Show login modal
        function showLoginModal() {
            console.log('üîê Showing login modal');
            const modal = document.getElementById('loginModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚úÖ Login modal displayed');
            } else {
                console.error('‚ùå Login modal element not found');
            }
        }

        // Hide login modal
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            clearLoginMessage();
            // Reset redirect and test buttons
            document.getElementById('googleRedirectBtn').style.display = 'none';
            document.getElementById('testPopupBtn').style.display = 'none';
        }

        // Clear login message
        function clearLoginMessage() {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.style.display = 'none';
            messageDiv.textContent = '';
            messageDiv.className = '';
        }

        // Show login message
        function showLoginMessage(message, type = 'error') {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.color = type === 'success' ? '#28a745' : '#dc3545';
        }

        // Handle Google login redirect result
        firebase.auth().getRedirectResult().then(async (result) => {
            if (result.user) {
                console.log('‚úÖ Google redirect login successful:', result.user.email);
                // Show success message briefly
                if (typeof showLoginMessage === 'function') {
                    showLoginMessage('Google login successful! Loading game...', 'success');
                }
                // The auth state listener will handle the rest
            } else if (result.credential) {
                console.log('üîÑ Google redirect completed but no user returned');
            }
        }).catch((error) => {
            console.error('‚ùå Google redirect login failed:', error);
            // Show error message if login modal is visible
            if (document.getElementById('loginModal').style.display === 'flex') {
                if (typeof showLoginMessage === 'function') {
                    showLoginMessage('Google login failed: ' + error.message, 'error');
                }
            }
        });

        // Initialize login modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Google login button
            document.getElementById('googleLoginBtn').addEventListener('click', async () => {
                try {
                    clearLoginMessage();
                    showLoginMessage('Signing in with Google...', 'info');

                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');

                    // Set custom parameters for better popup handling
                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });

                    // Only try popup method - no automatic redirect fallback
                    try {
                        console.log('üîÑ Attempting Google popup login...');

                        // Test if popups are allowed by opening a test popup
                        const testPopup = window.open('', '_blank', 'width=1,height=1');
                        if (!testPopup || testPopup.closed) {
                            console.log('‚ùå Popups are blocked by browser');
                            showLoginMessage('Popups are blocked. Please allow popups for this site or use the redirect option below.', 'error');
                            document.getElementById('googleRedirectBtn').style.display = 'block';
                            return;
                        }
                        testPopup.close();

                        // Add a small delay to ensure popup isn't blocked by rapid clicks
                        await new Promise(resolve => setTimeout(resolve, 100));

                        const result = await firebase.auth().signInWithPopup(provider);
                        console.log('‚úÖ Google popup login successful:', result.user.email);

                        showLoginMessage('Login successful! Loading game...', 'success');
                        setTimeout(() => hideLoginModal(), 1000);

                    } catch (popupError) {
                        console.log('‚ùå Popup login failed:', popupError.code, popupError.message);
                        console.log('‚ùå Full error object:', popupError);

                        // Handle specific popup errors without automatic redirect
                        if (popupError.code === 'auth/popup-closed-by-user') {
                            // Check if this was actually a user cancellation or a popup blocker
                            showLoginMessage('Popup was closed. If you didn\'t close it, your browser may be blocking popups.', 'error');
                            // Show both redirect and test options
                            document.getElementById('googleRedirectBtn').style.display = 'block';
                            document.getElementById('testPopupBtn').style.display = 'block';
                        } else if (popupError.code === 'auth/popup-blocked') {
                            showLoginMessage('Popup blocked by browser. Please allow popups for this site.', 'error');
                            // Show both redirect and test options
                            document.getElementById('googleRedirectBtn').style.display = 'block';
                            document.getElementById('testPopupBtn').style.display = 'block';
                        } else if (popupError.code === 'auth/cancelled-popup-request') {
                            showLoginMessage('Login request was cancelled. Please try again.', 'error');
                            // Show both options for this case
                            document.getElementById('googleRedirectBtn').style.display = 'block';
                            document.getElementById('testPopupBtn').style.display = 'block';
                        } else if (popupError.code === 'auth/network-request-failed') {
                            showLoginMessage('Network error. Please check your connection and try again.', 'error');
                        } else if (popupError.code === 'auth/unauthorized-domain') {
                            showLoginMessage('This domain is not authorized for Google login. Please contact support.', 'error');
                        } else {
                            // For other errors, show the actual error message and provide redirect option
                            showLoginMessage('Google login failed: ' + popupError.message + '. Try the redirect option below.', 'error');
                            document.getElementById('googleRedirectBtn').style.display = 'block';
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Google login failed:', error);
                    let errorMessage = 'Google login failed: ';

                    switch (error.code) {
                        case 'auth/popup-closed-by-user':
                            errorMessage = 'Login cancelled by user';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'Network error. Please check your connection.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Too many login attempts. Please try again later.';
                            break;
                        default:
                            errorMessage += error.message;
                    }

                    showLoginMessage(errorMessage, 'error');
                }
            });

            // Google redirect login button
            document.getElementById('googleRedirectBtn').addEventListener('click', async () => {
                try {
                    clearLoginMessage();
                    showLoginMessage('Redirecting to Google...', 'info');

                    const provider = new firebase.auth.GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });

                    console.log('üîÑ Using Google redirect login...');
                    await firebase.auth().signInWithRedirect(provider);

                } catch (error) {
                    console.error('‚ùå Google redirect login failed:', error);
                    showLoginMessage('Redirect login failed: ' + error.message, 'error');
                }
            });

            // Test popup button
            document.getElementById('testPopupBtn').addEventListener('click', () => {
                try {
                    const testPopup = window.open('about:blank', '_blank', 'width=400,height=300,scrollbars=yes,resizable=yes');
                    if (testPopup && !testPopup.closed) {
                        testPopup.document.write(`
                            <html>
                                <head><title>Popup Test</title></head>
                                <body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;">
                                    <h2>‚úÖ Popups Work!</h2>
                                    <p>Your browser allows popups for this site.</p>
                                    <p>You can now close this window and try Google login again.</p>
                                    <button onclick="window.close()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                                </body>
                            </html>
                        `);
                        showLoginMessage('Popup test successful! You can now try Google login.', 'success');
                    } else {
                        showLoginMessage('Popups are blocked. Please allow popups for this site and try again.', 'error');
                    }
                } catch (error) {
                    showLoginMessage('Popup test failed. Please allow popups for this site.', 'error');
                }
            });

            // Email/Password login form
            document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                clearLoginMessage();

                const email = document.getElementById('modalEmail').value;
                const password = document.getElementById('modalPassword').value;

                try {
                    showLoginMessage('Signing in...', 'info');
                    const result = await firebase.auth().signInWithEmailAndPassword(email, password);
                    console.log('‚úÖ Email login successful:', result.user.email);

                    showLoginMessage('Login successful! Loading game...', 'success');
                    hideLoginModal();
                } catch (error) {
                    console.error('‚ùå Email login failed:', error);
                    let errorMessage = 'Login failed: ';
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage += 'No account found with this email';
                            break;
                        case 'auth/wrong-password':
                            errorMessage += 'Incorrect password';
                            break;
                        case 'auth/invalid-email':
                            errorMessage += 'Invalid email address';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage += 'Too many failed attempts. Please try again later';
                            break;
                        default:
                            errorMessage += error.message;
                    }
                    showLoginMessage(errorMessage, 'error');
                }
            });

            // Close modal when clicking outside
            document.getElementById('loginModal').addEventListener('click', (e) => {
                if (e.target.id === 'loginModal') {
                    hideLoginModal();
                }
            });
        });
    </script>
    <!-- Game Scripts - Load in dependency order -->
    <script src="js/Scene.js?v=35"></script>
    <script src="js/InputManager.js?v=35"></script>
    <script src="js/SoundManager.js?v=35"></script>
    <script src="js/Player.js?v=35"></script>
    <script src="js/Obstacle.js?v=35"></script>
    <script src="js/StartScene.js?v=35"></script>
    <script src="js/GameScene.js?v=35"></script>
    <script src="js/GameOverScene.js?v=60"></script>
    <script src="js/Game.js?v=35"></script>
    <script src="js/Leaderboard.js?v=35"></script>
            <script src="js/AntiCheatManager.js?v=50&t=1752835000"></script>

    <script src="js/AdManager.js?v=30"></script>
    <script src="js/AdSenseManager.js?v=30"></script>
    <script src="js/AttemptsManager.js?v=40"></script>
    <script src="js/AttemptsUI.js?v=60"></script>
    <script src="js/PaymentManager.js?v=40"></script>
    <script src="js/PrizePoolManager.js?v=40"></script>
    <script src="js/main.js?v=40"></script>
    <script>
    async function purchaseAttemptsStripe(packageId) {
        const apiUrl = window.AppConfig ? `${window.AppConfig.apiBaseUrl}/api/payments/create-checkout-session` : 'http://localhost:3000/api/payments/create-checkout-session';
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ packageId })
        });
        const data = await response.json();
        if (data.url) {
            window.location.href = data.url; // Redirect to Stripe Checkout
        } else {
            alert('Failed to start purchase: ' + (data.error || 'Unknown error'));
        }
    }

    // Payment Success Modal Logic
    async function handleStripeSuccessPopup() {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id');
        if (!sessionId) return;
        // Remove session_id from URL after handling
        window.history.replaceState({}, document.title, window.location.pathname);
        const token = localStorage.getItem('authToken');
        let message = '';
        if (!token) {
            message = 'You must be logged in to receive attempts.';
        } else {
            try {
                const apiUrl = window.AppConfig ? `${window.AppConfig.apiBaseUrl}/api/payments/grant-attempts` : 'http://localhost:3000/api/payments/grant-attempts';
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ sessionId })
                });
                const data = await res.json();
                if (data.success) {
                    message = data.message;

                    // Force refresh attempts after successful payment
                    if (window.game && window.game.attemptsManager) {
                        await window.game.attemptsManager.refreshAttempts();
                        console.log('‚úÖ Attempts refreshed after payment');
                    }
                } else {
                    message = 'Failed to grant attempts: ' + (data.error || 'Unknown error');
                }
            } catch (e) {
                message = 'Failed to grant attempts: Network error.';
            }
        }
        showPaymentSuccessModal(message);
    }

    function showPaymentSuccessModal(message) {
        // Remove any existing modal
        const oldModal = document.getElementById('paymentSuccessModal');
        if (oldModal) oldModal.remove();
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'paymentSuccessModal';
        modal.style.cssText = `
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;`;
        modal.innerHTML = `
            <div style="background: #fff; padding: 32px 28px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); text-align: center; min-width: 320px; max-width: 90vw;">
                <h2 style="color: #4CAF50; margin-bottom: 18px;">Payment Successful!</h2>
                <div style="font-size: 1.1em; color: #333; margin-bottom: 18px;">${message}</div>
                <button onclick="document.getElementById('paymentSuccessModal').remove()" style="background: #4CAF50; color: #fff; border: none; padding: 10px 24px; border-radius: 6px; font-size: 1em; cursor: pointer;">Continue</button>
            </div>
        `;
        document.body.appendChild(modal);
    }

    document.addEventListener('DOMContentLoaded', handleStripeSuccessPopup);
    
    // Logout function
    async function logout() {
        try {
            await firebase.auth().signOut();
            window.location.href = 'login.html';
        } catch (error) {
            console.error('Logout error:', error);
            alert('Logout failed: ' + error.message);
        }
    }

    // Force refresh attempts (for debugging)
    async function forceRefreshAttempts() {
        console.log('üîÑ Force refreshing attempts...');
        if (window.game && window.game.attemptsManager) {
            await window.game.attemptsManager.refreshAttempts();
            console.log('‚úÖ Attempts refreshed!');
        } else {
            console.log('‚ùå Game or AttemptsManager not available');
        }
    }
    
    // Daily Free Attempt Functions
    async function claimDailyFreeAttempt() {
        if (!window.game || !window.game.attemptsManager) {
            alert('Game not loaded yet. Please wait and try again.');
            return;
        }
        
        const result = await window.game.attemptsManager.claimDailyFreeAttempt();
        
        if (result.success) {
            alert('üéâ Daily free attempt claimed successfully!');
            // Refresh attempts display
            if (window.game.attemptsUI) {
                window.game.attemptsUI.updateDisplay();
            }
            // Update the daily attempt status to hide the button
            await updateDailyAttemptStatus();
        } else {
            alert('‚ùå ' + result.message);
        }
    }
    
    async function updateDailyAttemptStatus() {
        if (!window.game || !window.game.attemptsManager) {
            console.log('Attempts manager not ready yet');
            return;
        }
        
        try {
            const status = await window.game.attemptsManager.checkDailyFreeAttempt();
            const claimBtn = document.getElementById('claimDailyBtn');
            const dailyAttemptDiv = document.getElementById('daily-free-attempt');
            
            if (!claimBtn || !dailyAttemptDiv) {
                console.log('Daily free attempt elements not found');
                return;
            }
            
            if (status.available) {
                claimBtn.disabled = false;
                claimBtn.style.opacity = '1';
                claimBtn.textContent = 'Claim';
                dailyAttemptDiv.style.display = 'block'; // Show the button
                console.log('Daily free attempt available');
            } else {
                claimBtn.disabled = true;
                claimBtn.style.opacity = '0.6';
                claimBtn.textContent = 'Claimed';
                dailyAttemptDiv.style.display = 'none'; // Hide the button
                console.log('Daily free attempt already claimed today');
            }
        } catch (error) {
            console.error('Error updating daily attempt status:', error);
            // Hide the button on error to be safe
            const dailyAttemptDiv = document.getElementById('daily-free-attempt');
            if (dailyAttemptDiv) {
                dailyAttemptDiv.style.display = 'none';
            }
        }
    }
    
    // Check daily attempt status when page loads and periodically
    document.addEventListener('DOMContentLoaded', function() {
        // Initial check after game loads
        setTimeout(updateDailyAttemptStatus, 2000);
        
        // Check every 5 minutes to handle timezone changes and day transitions
        setInterval(updateDailyAttemptStatus, 5 * 60 * 1000);
    });
    </script>



    <!-- Footer with Privacy Policy Link -->
    <div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000;">
        <a href="#" onclick="showPrivacyModal()" style="
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            color: #222;
            text-decoration: none;
            text-transform: uppercase;
            background: #fff;
            padding: 8px 12px;
            border: 2px solid #222;
            border-radius: 0;
            transition: background 0.15s, color 0.15s;
        " onmouseover="this.style.background='#222'; this.style.color='#fff'" 
           onmouseout="this.style.background='#fff'; this.style.color='#222'">
            Privacy Policy
        </a>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacyModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: #fff; margin: 5% auto; padding: 20px; border: 2px solid #222; border-radius: 0; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; font-family: 'Press Start 2P', monospace;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #222;">
                <h2 class="modal-title" style="color: #222; font-size: 1.2rem; margin: 0; text-transform: uppercase;">Privacy Policy</h2>
                <button class="close" onclick="closePrivacyModal()" style="color: #222; font-size: 1.5rem; font-weight: bold; cursor: pointer; background: none; border: none; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>
            <div class="modal-body" style="font-size: 0.6rem; line-height: 1.6; color: #222; text-align: left;">
                <p><strong>Effective Date:</strong> July 9, 2025</p>
                <p><strong>Platform:</strong> SkySurge</p>

                <h2 style="font-size: 0.8rem; margin: 20px 0 10px 0; text-transform: uppercase;">1. Data We Collect</h2>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li style="margin: 4px 0;">Login credentials (email or social login)</li>
                    <li style="margin: 4px 0;">IP address, browser/device info</li>
                    <li style="margin: 4px 0;">Gameplay data (score, attempts, timestamps)</li>
                    <li style="margin: 4px 0;">Payment activity (via Stripe)</li>
                    <li style="margin: 4px 0;">Ad interactions (via Google AdSense)</li>
                </ul>

                <h2 style="font-size: 0.8rem; margin: 20px 0 10px 0; text-transform: uppercase;">2. How We Use Your Data</h2>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li style="margin: 4px 0;">To authenticate users and secure sessions</li>
                    <li style="margin: 4px 0;">To track legitimate gameplay and contest performance</li>
                    <li style="margin: 4px 0;">To detect and prevent cheating or fraud</li>
                    <li style="margin: 4px 0;">To process payments and prize payouts</li>
                    <li style="margin: 4px 0;">To monitor platform usage and improve the experience</li>
                </ul>

                <h2 style="font-size: 0.8rem; margin: 20px 0 10px 0; text-transform: uppercase;">3. Third-Party Services</h2>
                <p style="margin: 8px 0;">SkySurge uses:</p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li style="margin: 4px 0;">Firebase for authentication</li>
                    <li style="margin: 4px 0;">Stripe for payment processing</li>
                    <li style="margin: 4px 0;">Google AdSense for advertising</li>
                </ul>
                <p style="margin: 8px 0;">These services may collect limited data in accordance with their own privacy policies.</p>

                <h2 style="font-size: 0.8rem; margin: 20px 0 10px 0; text-transform: uppercase;">4. Cookies and Tracking</h2>
                <p style="margin: 8px 0;">SkySurge uses cookies to manage sessions and preferences.</p>
                <p style="margin: 8px 0;">Some cookies may be used by Google AdSense for ad personalization.</p>
                <p style="margin: 8px 0;">Users may disable cookies in browser settings, but functionality may be limited.</p>

                <h2 style="font-size: 0.8rem; margin: 20px 0 10px 0; text-transform: uppercase;">5. Data Security</h2>
                <p style="margin: 8px 0;">All data is stored securely with encryption, access controls, and logging.</p>
                <p style="margin: 8px 0;">We monitor for unauthorized access or suspicious activity.</p>

                <h2 style="font-size: 0.8rem; margin: 20px 0 10px 0; text-transform: uppercase;">6. Your Rights</h2>
                <p style="margin: 8px 0;">You may request:</p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li style="margin: 4px 0;">Access to your stored data</li>
                    <li style="margin: 4px 0;">Deletion of your account</li>
                    <li style="margin: 4px 0;">Correction of inaccurate information</li>
                </ul>
                <p style="margin: 8px 0;">Contact [your email] for data-related requests.</p>
            </div>
        </div>
    </div>

    <script>
        // Privacy Policy Modal functions
        function showPrivacyModal() {
            document.getElementById('privacyModal').style.display = 'block';
        }

        function closePrivacyModal() {
            document.getElementById('privacyModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const privacyModal = document.getElementById('privacyModal');
            if (event.target === privacyModal) {
                closePrivacyModal();
            }
        }
    </script>
</body>
</html> 